#!/bin/sh

mkdir -p bin
( cd bin &&  wget https://niemeyer.s3.amazonaws.com/spread-amd64.tar.gz -O spread.tar.gz && tar xzvf spread.tar.gz )
git clone https://github.com/fgimenez/validator target

. ./options
SPREAD_TARGET_UBUNTU_CORE_REVISION=$(echo "$TRAVIS_COMMIT_MESSAGE" | perl -n -e '/'"$message"' \((.*?)\)/ && print $1')
SPREAD_TARGET_SNAPD_VERSION=$(git ls-remote --heads https://github.com/snapcore/snapd.git | awk '{print $2}' | grep release | awk -F"/" '{print $4}' | tail -n 1)

export UBUNTU_CORE_CHANNEL=edge
export SPREAD_TARGET_UBUNTU_CORE_REVISION
export SPREAD_TARGET_SNAPD_VERSION

cd target || exit
../bin/spread -v linode:ubuntu-16.04-64 linode:ubuntu-16.04-32 linode:ubuntu-14.04-64
